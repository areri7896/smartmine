{% extends 'src/dashboard/basic.html' %} {% load static %}

<title>{% block title %}Exchange{% endblock %}</title>

{% block css_links %}
<link href="{% static 'assets/media/images/icons/logo.svg' %}" rel="shortcut icon" type="image/x-icon" />
<link href="{% static 'assets/css/styles.bundle.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'assets/plugins/apexcharts/apexcharts.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'assets/css/pages/exchange-v1.css' %}" rel="stylesheet" type="text/css" />
{% endblock %} {% block content %}
<div class="container container--dashboard container--dashboard--exchange-v1">
  <div class="dashboard__group dashboard__group--exchange-v1">
    <div class="dashboard__group-left">
      <!-- Messages -->
      {% if messages %}
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast bg-primary" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <strong class="me-auto">Alert</strong>
            <small class="text-muted">Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body bg-primary" id="toastMessage">
            {% for message in messages %} {{ message }} {% endfor %}
          </div>
        </div>
      </div>
      <script>
        window.addEventListener("DOMContentLoaded", () => {
          const toastEl = document.getElementById("liveToast");
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        });
      </script>
      {% endif %}

      <!-- Crypto Card Info Section -->
      {% if tickers %} {% for ticker in tickers %}
      <div class="standard-card standard-card--type-8-v2">
        <div class="standard-card__container">
          <div class="standard-card__items">
            <div class="standard-card__item standard-card__item--1">
              <div class="standard-card__item-left">
                <img src="{% static 'assets/media/images/icons/logo-'|add:ticker.baseAsset|lower|add:'.svg' %}"
                  alt="{{ ticker.baseAsset }}" class="standard-card__item-image"
                  onerror="this.src='{% static 'assets/media/images/icons/logo-btc.svg' %}'" />
                <div class="standard-card__item-desc">
                  <p class="fb-regular standard-card__item-title">
                    {{ ticker.baseAsset }}
                  </p>
                  <p class="fd-sm fd-sm--bold standard-card__item-crypto">
                    {{ ticker.symbol }}
                  </p>
                </div>
                <img src="{% static 'assets/media/images/icons/arrow-down.svg' %}" alt=""
                  class="standard-card__item-arrow" />
              </div>
              <div class="standard-card__item-collapse">
                <div class="item-collapse__group-1">
                  <div class="item-collapse__title">
                    <p class="fb-sm item-collapse__title-text">24h Change</p>
                    <div class="item-collapse__title-influsion">
                      <img
                        src="{% static 'assets/media/images/icons/arrow-'|add:'bullish' if ticker.priceChangePercent|floatformat:2 > 0 else 'bearish'|add:'.svg' %}"
                        alt="" class="item-collapse__title-influsion-icon" />
                      <p
                        class="fb-regular fb-regular--bold item-collapse__title-influsion-value {% if ticker.priceChangePercent|floatformat:2 > 0 %}text-bullish{% else %}text-bearish{% endif %}">
                        {{ ticker.priceChangePercent|floatformat:2 }}%
                      </p>
                    </div>
                  </div>
                  <div class="item-collapse__chart-wrapper">
                    <!-- Data for JS -->
                    <div class="ticker-chart-data" data-id="{{ forloop.counter }}"
                      data-series="{{ chart_data.series|safe }}" data-labels="{{ chart_data.labels|safe }}"
                      style="display:none;"></div>
                    <div id="item-collapse__chart-line-{{ forloop.counter }}" class="item-collapse__chart-render"></div>
                  </div>
                </div>
                <div class="item-collapse__group-2">
                  <p class="fb-sm item-collapse__price">
                    Last Price:
                    <span class="item-collapse__price-value text-bullish">USD {{ ticker.lastPrice|floatformat:2 }}</span>
                  </p>
                  <p class="fb-sm item-collapse__price">
                    24h Low:
                    <span class="item-collapse__price-value text-bearish">{{ ticker.lowPrice|floatformat:2 }}</span>
                  </p>
                </div>
              </div>
            </div>
            <div class="standard-card__item standard-card__item--2">
              <div class="standard-card__item-left">
                <p class="fb-regular standard-card__item-title">24h Change</p>
                <div class="standard-card__item-influsion">
                  <img
                    src="{% static 'assets/media/images/icons/arrow-'|add:'bullish' if ticker.priceChangePercent|floatformat:2 > 0 else 'bearish'|add:'.svg' %}"
                    alt="" class="standard-card__item-influsion-icon" />
                  <p
                    class="fd-sm fd-sm--bold standard-card__item-influsion-value {% if ticker.priceChangePercent|floatformat:2 > 0 %}text-bullish{% else %}text-bearish{% endif %}">
                    {{ ticker.priceChangePercent|floatformat:2 }}%
                  </p>
                </div>
              </div>
              <div class="standard-card__item-chart-wrapper">
                <div id="standard-card__item-line-{{ forloop.counter }}" class="standard-card__item-chart-render"></div>
              </div>
            </div>
            <div class="standard-card__item standard-card__item--3">
              <p class="fb-regular standard-card__item-title">Last Price</p>
              <p class="fd-sm fd-sm--bold standard-card__item-value">
                {{ ticker.lastPrice|floatformat:2 }} USD
              </p>
            </div>
            <div class="standard-card__item standard-card__item--4">
              <p class="fb-regular standard-card__item-title">24h Low</p>
              <p class="fd-sm fd-sm--bold standard-card__item-value">
                {{ ticker.lowPrice|floatformat:2 }} USD
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      <!-- Pagination -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if tickers.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ tickers.previous_page_number }}">Previous</a>
          </li>
          {% endif %} {% for num in tickers.paginator.page_range %}
          <li class="page-item {% if tickers.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
          </li>
          {% endfor %} {% if tickers.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ tickers.next_page_number }}">Next</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% else %}
      <p class="text-muted">No trading pairs available at the moment.</p>
      {% endif %}

      <!-- Candlestick Chart Section -->
      <div class="complete-card complete-card--type-3">
        <div class="complete-card__head">
          <div class="complete-card__head-title-wrapper">
            <h5 class="complete-card__head-title">BTCUSDT</h5>
            <div class="dropdown complete-card__dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton3"
                data-bs-toggle="dropdown" aria-expanded="false">
                1 min
                <img src="{% static 'assets/media/images/icons/arrow-down.svg' %}" alt="" />
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                <li><a class="dropdown-item" href="#">1 min</a></li>
                <li><a class="dropdown-item" href="#">3 min</a></li>
                <li><a class="dropdown-item" href="#">30 min</a></li>
                <li><a class="dropdown-item" href="#">1 hour</a></li>
                <li><a class="dropdown-item" href="#">24 hour</a></li>
                <li><a class="dropdown-item" href="#">1 day</a></li>
                <li><a class="dropdown-item" href="#">1 week</a></li>
              </ul>
            </div>
          </div>
          <ul class="complete-card__head-tabs" id="pills-tab" role="tablist">
            <li class="complete-card__head-tab">
              <button class="fb-regular fb-regular--bold complete-card__head-tab-text active" id="chart-price-2-tab"
                data-bs-toggle="pill" data-bs-target="#chart-price-2" type="button" role="tab"
                aria-controls="chart-price-2" aria-selected="true">
                Price
              </button>
            </li>
            <li class="complete-card__head-tab">
              <button class="fb-regular fb-regular--bold complete-card__head-tab-text" id="chart-depth-2-tab"
                data-bs-toggle="pill" data-bs-target="#chart-depth-2" type="button" role="tab"
                aria-controls="chart-depth-2" aria-selected="false">
                Depth
              </button>
            </li>
          </ul>
          <div class="complete-card__head-values">
            <p class="fb-sm complete-card__head-menu">
              Open:
              <span class="complete-card__head-value">{{ tickers.0.openPrice|floatformat:2|default:"N/A" }}</span>
            </p>
            <p class="fb-sm complete-card__head-menu">
              High:
              <span class="complete-card__head-value">{{ tickers.0.highPrice|floatformat:2|default:"N/A" }}</span>
            </p>
            <p class="fb-sm complete-card__head-menu">
              Low:
              <span class="complete-card__head-value">{{ tickers.0.lowPrice|floatformat:2|default:"N/A" }}</span>
            </p>
            <p class="fb-sm complete-card__head-menu">
              Close:
              <span class="complete-card__head-value">{{ tickers.0.closePrice|floatformat:2|default:"N/A" }}</span>
            </p>
          </div>
          <div class="complete-card__head-dropdown">
            <div class="dropdown complete-card__dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton4"
                data-bs-toggle="dropdown" aria-expanded="false">
                Price
                <img src="{% static 'assets/media/images/icons/arrow-down.svg' %}" alt="" />
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton4" id="pills-tab" role="tablist">
                <li>
                  <a class="dropdown-item active" href="#" id="chart-price-tab" data-bs-toggle="pill"
                    data-bs-target="#chart-price" role="tab" aria-controls="chart-price" aria-selected="true">Price</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="chart-depth-tab" data-bs-toggle="pill"
                    data-bs-target="#chart-depth" role="tab" aria-controls="chart-depth" aria-selected="false">Depth</a>
                </li>
              </ul>
            </div>
            <div class="dropdown complete-card__dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton5"
                data-bs-toggle="dropdown" aria-expanded="false">
                {{ current_interval|default:"1h" }}
                <img src="{% static 'assets/media/images/icons/arrow-down.svg' %}" alt="" />
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton5" id="pills-tab" role="tablist">
                <li><a class="dropdown-item" href="?interval=1m">1 min</a></li>
                <li><a class="dropdown-item" href="?interval=3m">3 min</a></li>
                <li><a class="dropdown-item" href="?interval=30m">30 min</a></li>
                <li><a class="dropdown-item" href="?interval=1h">1 hour</a></li>
                <li><a class="dropdown-item" href="?interval=4h">4 hours</a></li>
                <li><a class="dropdown-item" href="?interval=1d">1 day</a></li>
                <li><a class="dropdown-item" href="?interval=1w">1 week</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="tab-content tab-content--desktop">
          <div class="tab-pane fade show active" id="chart-price" role="tabpanel" aria-labelledby="chart-price-tab">
            <div class="complete-card__chart-wrapper">
              <div id="complete-card__chart-candlestick-1" class="complete-card__chart-render"></div>
              <img src="{% static 'assets/media/images/background-bar.png' %}" alt=""
                class="complete-card__chart-candlestick-column-bar" />
              <div class="complete-card__chart-area-vignette--left"></div>
              <div class="complete-card__chart-area-vignette--top"></div>
              <div class="complete-card__chart-area-vignette--right"></div>
            </div>
          </div>
          <div class="tab-pane fade" id="chart-depth" role="tabpanel" aria-labelledby="chart-depth-tab">
            <div class="complete-card__chart-wrapper">
              <div id="complete-card__chart-depth-1" class="complete-card__chart-render"></div>
            </div>
          </div>
        </div>
        <div class="tab-content tab-content--mobile">
          <div class="tab-pane fade show active" id="chart-price-2" role="tabpanel" aria-labelledby="chart-price-2-tab">
            <div class="complete-card__chart-wrapper">
              <div id="complete-card__chart-candlestick-2" class="complete-card__chart-render"></div>
              <img src="{% static 'assets/media/images/background-bar.png' %}" alt=""
                class="complete-card__chart-candlestick-column-bar" />
              <div class="complete-card__chart-area-vignette--left"></div>
              <div class="complete-card__chart-area-vignette--top"></div>
              <div class="complete-card__chart-area-vignette--right"></div>
            </div>
          </div>
          <div class="tab-pane fade" id="chart-depth-2" role="tabpanel" aria-labelledby="chart-depth-2-tab">
            <div class="complete-card__chart-wrapper">
              <div id="complete-card__chart-depth-2" class="complete-card__chart-render"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Market Trades Table Section -->
      <div class="table-wrapper table--type-3">
        <div class="table__title">
          <h6 class="table__title-text">Market Trades</h6>
          <nav class="navbar">
            <div class="table__title-tabs" id="pills-tab" role="tablist">
              <li class="nav-item">
                <p class="fb-regular fb-regular--bold table__title-tab active" id="pills-market-trades-open-order-tab"
                  data-bs-toggle="pill" data-bs-target="#pills-market-trades-open-order" role="tab"
                  aria-controls="pills-market-trades-open-order" aria-selected="true">
                  Open Order
                </p>
              </li>
              <li class="nav-item">
                <p class="fb-regular fb-regular--bold table__title-tab" id="pills-market-trades-order-history-tab"
                  data-bs-toggle="pill" data-bs-target="#pills-market-trades-order-history" role="tab"
                  aria-controls="pills-market-trades-order-history" aria-selected="false">
                  Order History
                </p>
              </li>
              <li class="nav-item">
                <p class="fb-regular fb-regular--bold table__title-tab" id="pills-market-trades-order-book-tab"
                  data-bs-toggle="pill" data-bs-target="#pills-market-trades-order-book" role="tab"
                  aria-controls="pills-market-trades-order-book" aria-selected="false">
                  Order Book
                </p>
              </li>
            </div>
          </nav>
        </div>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="pills-market-trades-open-order" role="tabpanel"
            aria-labelledby="pills-market-trades-open-order-tab">
            <div class="table-container">
              <table class="table table-content">
                <thead>
                  <tr>
                    <th class="fb-regular table__head">Time</th>
                    <th class="fb-regular table__head">Price (USD)</th>
                    <th class="fb-regular table__head">Amount (BTC)</th>
                    <th class="fb-regular table__head">Total (USD)</th>
                  </tr>
                </thead>
                <tbody id="trade-table-body">
                  {% for trade in trades %}
                  <tr>
                    <td>
                      <p class="fb-regular">{{ trade.created_at|date:"H:i:s" }}</p>
                    </td>
                    <td>
                      <p class="fb-regular {% if trade.side == 'BUY' %}text-bullish{% else %}text-bearish{% endif %}">
                        {{ trade.price|floatformat:2 }}
                      </p>
                    </td>
                    <td>
                      <p class="fb-regular">{{ trade.amount|floatformat:4 }}</p>
                    </td>
                    <td>
                      <p class="fb-regular">{{ trade.total|floatformat:2 }}</p>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4">
                      <p class="fb-regular text-muted">
                        No recent trades available.
                      </p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="table__vignette"></div>
      </div>
    </div>
    <!-- Crypto Exchange Section -->
    <form method="POST" action="{% url 'trade' %}">
      {% csrf_token %}
      <div class="advance-card advance-card--type-2">
        <div class="advance-card__title">
          <h6 class="advance-card__title-text">Bitcoin</h6>
          <img src="{% static 'assets/media/images/icons/logo-btc.svg' %}" alt="" class="advance-card__title-image" />
        </div>
        <div class="advance-card__form">
          <div class="advance-card__form-title">
            <p class="advance-card__form-title-text">Enter your trade Amount</p>
          </div>
          <div class="forms-purchase forms-purchase--advance-card">
            <div class="forms-group forms-group--value">
              <input type="number" min="0" step="0.000001" name="balance_amount" placeholder="Quantity" class="form-control forms-purchase__value" required />
            </div>
            <div class="forms-group forms-group--purchase js-forms-group--purchase" id="custom-select-purchase3">
              <select name="balance_currency" class="form-control">
                <option value="BTC" selected>BTC</option>
                <option value="HOM">HOM</option>
                <option value="ETH">ETH</option>
                <option value="BNB">BNB</option>
              </select>
            </div>
          </div>
          <div class="mt-2">
             <small class="text-muted">Available USD: ${{ wallet_usd|floatformat:2 }}</small><br>
             {% if portfolio %}
             <small class="text-muted">Your Assets: 
                {% for sym, amt in portfolio.items %}
                    {{ sym }}: {{ amt|floatformat:4 }} &nbsp;
                {% endfor %}
             </small>
             {% endif %}
          </div>
        </div>
        <div class="advance-card__form">
          <div class="advance-card__form-title">
            <p class="advance-card__form-title-text">Volume (24h)</p>
            <div class="advance-card__form-title-percent">
              <img
                src="{% static 'assets/media/images/icons/arrow-'|add:'bullish' if tickers.0.priceChangePercent|floatformat:2 > 0 else 'bearish'|add:'.svg' %}"
                alt="" class="advance-card__form-title-percent-image" />
              <p
                class="advance-card__form-title-percent-value {% if tickers.0.priceChangePercent|floatformat:2 > 0 %}text-bullish{% else %}text-bearish{% endif %}">
                {{ tickers.0.priceChangePercent|floatformat:2|default:"N/A" }}%
              </p>
            </div>
          </div>
        </div>
        <div class="advance-card__buttons">
          <button type="submit" name="action" value="buy"
            class="btn btn-secondary advance-card__button button--green">Buy</button>
          <button type="submit" name="action" value="sell"
            class="btn btn-secondary advance-card__button button--red">Sell</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Candlestick data for JS -->
<div id="candlestick-data" data-series="{{ candlestick_data|safe }}" style="display:none;"></div>

{% block js %}
<script src="{% static 'assets/js/scripts.bundle.js' %}"></script>
<script src="{% static 'assets/js/custom/sidebar.js' %}"></script>
<script src="{% static 'assets/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'assets/plugins/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'assets/plugins/slick/slick.min.js' %}"></script>
<script src="{% static 'assets/js/custom/chart.js' %}"></script>
<script src="{% static 'assets/js/custom/navbar.js' %}"></script>
<script src="{% static 'assets/js/custom/custom-select.js' %}"></script>
<script src="{% static 'assets/js/custom/dropdown.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof ApexCharts !== 'undefined') {
      // Initialize small line charts
      const dataDivs = document.querySelectorAll('.ticker-chart-data');
      dataDivs.forEach(div => {
        const i = div.dataset.id;
        const series = JSON.parse(div.dataset.series);
        const labels = JSON.parse(div.dataset.labels);

        const options = {
          chart: { type: 'line', height: 100, sparkline: { enabled: true } },
          series: series,
          xaxis: { categories: labels },
          colors: ['#246cf9'],
          stroke: { curve: 'smooth' }
        };

        const el1 = document.querySelector("#item-collapse__chart-line-" + i);
        if (el1) new ApexCharts(el1, options).render();

        const el2 = document.querySelector("#standard-card__item-line-" + i);
        if (el2) new ApexCharts(el2, options).render();
      });

      // Initialize candlestick charts
      const candDiv = document.querySelector('#candlestick-data');
      if (candDiv) {
        const candSeries = JSON.parse(candDiv.dataset.series);
        const candOptions = {
          chart: { type: 'candlestick', height: 350 },
          series: [{ data: candSeries }],
          xaxis: { type: 'datetime' },
          yaxis: { tooltip: { enabled: true } }
        };

        const candEl1 = document.querySelector("#complete-card__chart-candlestick-1");
        if (candEl1) new ApexCharts(candEl1, candOptions).render();

        const candEl2 = document.querySelector("#complete-card__chart-candlestick-2");
        if (candEl2) new ApexCharts(candEl2, candOptions).render();
      }

      // Initialize depth charts (sample)
      const depthOptions = {
        chart: { type: 'area', height: 350 },
        series: [
          { name: 'Buy', data: [100, 200, 150, 300] },
          { name: 'Sell', data: [50, 100, 75, 150] }
        ],
        xaxis: { categories: ['Price1', 'Price2', 'Price3', 'Price4'] },
        colors: ['#27f7db', '#ff5733']
      };

      const depthEl1 = document.querySelector("#complete-card__chart-depth-1");
      if (depthEl1) new ApexCharts(depthEl1, depthOptions).render();
    }
  });
</script>
{% endblock %} {% endblock %}