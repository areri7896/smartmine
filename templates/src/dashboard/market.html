{% extends 'src/dashboard/basic.html' %}
{% load static %}
<title>{% block title %}Market {% endblock %}</title>
{% block css_page %}
<link href="{% static 'assets/media/images/icons/logo.svg' %}" rel="shortcut icon" type="image/x-icon" />

<!-- Start::Global Styles (used by all pages) -->
<link href="{% static 'assets/css/styles.bundle.css' %}" rel="stylesheet" type="text/css" />
<!-- End::Global Styles -->
<!-- Start::Plugins (used by this page) -->
<link href="{% static 'assets/plugins/apexcharts/apexcharts.css' %}" rel="stylesheet" type="text/css" />
<!-- End::Plugins -->
<!-- Start::Page Styles (used by this page) -->
<link href="{% static 'assets/css/pages/wallet-v1.css' %}" rel="stylesheet" type="text/css" />
<!-- End::Page Styles -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% endblock %}
</head>
{% block content %}

<div class="wallet wallet--v1">
  <div class="container container--dashboard">
    <div class="wallet-group">
      <div class="wallet-group--left">
        {% for plan in plans %}
        <div class="standard-card standard-card--type-6-v1">
          <div class="container">
            <div class="standard-card__content">
              <div class="standard-card__content-head">
                <div class="standard-card__content-currency">
                  <p class="standard-card__content-currency-name">{{ plan.name }}</p>
                </div>
                <p class="standard-card__content-percentage text-bullish">
                  {{ plan.daily_interest_rate }}%
                </p>
              </div>
              <div class="standard-card__content-head">
                <p class="standard-card__content-price-1">{{ plan.cycle_days }} Days</p>
                <p class="standard-card__content-price-2">{{ plan.price }} KSH</p>
              </div>

              <!-- Button to open confirmation modal -->
              <form action="{% url 'invest' plan.id %}" method="post">
                {% csrf_token %}
                <a class="btn btn-secondary btn-sm invest-button" href="{% url 'confirm_investment' plan.id %}">
                  Invest Now
                </a>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="wallet-group--right">

        <!-- Start::Table Section -->
        <div class="table-wrapper table--type-1">
          {% if investments %}
          <div class="table-container" style="overflow-x: auto; max-width: 100%;">
            <h6 class="component__title mb-3 text-center">My Investments</h6>
            <table class="table table-content" style="width: 100%; min-width: 600px;">
              <thead class="table__head">
                <tr>
                  <th class="fb-regular table__head" style="white-space: nowrap;">Investment Plan</th>
                  <th class="fb-regular table__head" style="white-space: nowrap;">Start Date</th>
                  <th class="fb-regular table__head" style="white-space: nowrap;">End Date</th>
                  <th class="fb-regular table__head" style="white-space: nowrap;">Remaining Time</th>
                  <th class="fb-regular table__head" style="white-space: nowrap;">Status</th>
                </tr>
              </thead>
              <tbody>{% for investment in investments %}
                <tr id="investment-row-{{ investment.id }}">
                  <td style="padding: 10px 5px;">
                    <p class="fb-regular table__assets-crypto-abbr" style="margin: 0; font-size: 0.9rem;">
                      {{investment.plan.name }}</p>
                  </td>
                  <td style="padding: 10px 5px;">
                    <p class="fb-regular table__order" style="margin: 0; font-size: 0.85rem;">
                      {{investment.start_date|date:"Y-m-d H:i" }}</p>
                  </td>
                  <td style="padding: 10px 5px;">
                    <p class="fb-regular table__available" style="margin: 0; font-size: 0.85rem;">
                      {{investment.end_date|date:"Y-m-d H:i" }}</p>
                  </td>
                  <td style="padding: 10px 5px;">
                    <p class="fb-regular countdown-timer text-primary" data-endtime="{{ investment.end_date|date:'c' }}"
                      id="timer-{{ investment.id }}" style="margin: 0; font-size: 0.85rem;">Calculating...</p>
                  </td>
                  <td style="padding: 10px 5px;">{% if investment.status == 'active' %}<p
                      class="fb-regular table__status text-success" id="status-{{ investment.id }}"
                      style="margin: 0; font-size: 0.85rem;">{{ investment.status }}</p>{% else %}<p
                      class="fb-regular table__status text-danger" id="status-{{ investment.id }}"
                      style="margin: 0; font-size: 0.85rem;">{{ investment.status }}</p>{% endif %}</td>
                </tr>{% empty %}<tr>
                  <td colspan="5" class="text-center">You have not invested yet! <span class="text-danger">Please
                      Invest</span></td>
                </tr>{% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        {% else %}
        <p class="standard-card__content-currency-name mb-3 text-center">You have not invested yet! <span
            class="text-danger"> Please Invest </span></p>
        {% endif %}
        <!-- End::Table Section -->
        <!-- base.html or any template -->
        {% if messages %}
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
          <div id="liveToast" class="toast bg-primary" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
              <strong class="me-auto">Alert</strong>
              <small class="text-muted">Just now</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-primary" id="toastMessage">
              {% for message in messages %}
              {{ message }}
              {% endfor %}
            </div>
          </div>
        </div>

        <script>
          window.addEventListener('DOMContentLoaded', () => {
            const toastEl = document.getElementById('liveToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
          });
        </script>
        {% endif %}

      </div>

    </div>
  </div>
</div>
{% block js %}
<!-- Start::Global Bundle Scripts (used by all pages) -->
<script src="{% static 'assets/js/scripts.bundle.js' %}"></script>
<script src="{% static 'assets/js/custom/sidebar.js' %}"></script>
<!-- End::Global Bundle Scripts -->
<!-- Start::Plugins (used by this page) -->
<script src="{% static 'assets/plugins/apexcharts/apexcharts.min.js' %}"></script>
<!-- Bootstrap JS (place before closing </body>) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="{% static 'assets/plugins/slick/slick.min.js' %}"></script>
<!-- End::Plugins -->
<!-- Start::Page Scripts (used by this page) -->
<script src="{% static 'assets/js/custom/chart.js' %}"></script>
<script src="{% static 'assets/js/pages/wallet-page-v1.js' %}"></script>
<script src="{% static 'assets/js/custom/navbar.js' %}"></script>
<!-- End::Page Scripts -->

<script>
  function updateCountdowns() {
    const now = new Date().getTime();
    const timers = document.querySelectorAll('.countdown-timer');

    timers.forEach(timer => {
      const endTimeStr = timer.getAttribute('data-endtime');
      if (!endTimeStr) return;

      const endTime = new Date(endTimeStr).getTime();
      const distance = endTime - now;
      const timerId = timer.id.split('-')[1];
      const statusEl = document.getElementById('status-' + timerId);

      if (distance < 0) {
        timer.innerHTML = "Expired";
        timer.classList.remove('text-primary');
        timer.classList.add('text-danger');

        // Update status text if it's currently "active"
        if (statusEl && statusEl.innerHTML.trim().toLowerCase() === 'active') {
          statusEl.innerHTML = 'Completed/Processing';
          statusEl.classList.remove('text-success');
          statusEl.classList.add('text-info');
          // Optional: reload page to sync with backend after a small delay
          // setTimeout(() => { window.location.reload(); }, 5000);
        }
      } else {
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        let displayStr = "";
        if (days > 0) displayStr += days + "d ";
        displayStr += (hours < 10 ? "0" + hours : hours) + "h " +
          (minutes < 10 ? "0" + minutes : minutes) + "m " +
          (seconds < 10 ? "0" + seconds : seconds) + "s";

        timer.innerHTML = displayStr;
      }
    });
  }

  // Run every second
  setInterval(updateCountdowns, 1000);
  // Initial run
  document.addEventListener('DOMContentLoaded', updateCountdowns);
</script>
{% endblock %}
{% endblock %}